<!DOCTYPE html>
<html>
<head>
    <meta charset="utf-8" />
    <title>Stack Viewer</title>
    <link rel="stylesheet" href="../static/foundation-6.2.3-custom/css/foundation.css">
    <link rel="stylesheet" href="../static/foundation-6.2.3-custom/css/app.css">
    <link href="../libraries/jquery.treetable/css/jquery.treetable.css" rel="stylesheet" type="text/css" />
    <link href="../static/stackviewer.css" rel="stylesheet" type="text/css" />
</head>
<body>
    <form id="filtersForm">
        Start:<input class="filter" name="start" list="start-filter-list" type="text">
        <datalist id="start-filter-list"></datalist>

        End:<input class="filter" name="end" list="end-filter-list" type="text">
        <datalist id="end-filter-list"></datalist>

        Find:<input class="filter" name="find" list="find-filter-list" type="text">
        <datalist id="find-filter-list"></datalist>

        GroupPats:<input class="filter" name="grouppats" list="grouppats-filter-list" type="text">
        <datalist id="grouppats-filter-list"></datalist>

        Fold%:<input class="filter" name="foldpct" list="foldpercent-filter-list" type="text">
        <datalist id="foldpercent-filter-list"></datalist>

        FoldPats:<input class="filter" name="foldpats" list="foldpats-filter-list" type="text">
        <datalist id="foldpats-filter-list"></datalist>

        IncPats:<input class="filter" name="incpats" list="incpats-filter-list" type="text">
        <datalist id="incpats-filter-list"></datalist>

        ExcPats:<input class="filter" name="excpats" list="excpats-filter-list" type="text">
        <datalist id="excpats-filter-list"></datalist>
    </form>

    <ul class="tabs" data-tabs id="tabs">
        <li class="tabs-title is-active"><a href="#by-name" aria-selected="true">By Name</a></li>
        <li class="tabs-title"><a href="#caller-callee">Caller-Callee</a></li>
        <li class="tabs-title"><a href="#call-tree">CallTree</a></li>
        <li class="tabs-title"><a href="#callers">Callers</a></li>
        <li class="tabs-title"><a href="#callees">Callees</a></li>
        <li class="tabs-title"><a href="#notes">Notes</a></li>
    </ul>

    <div class="tabs-content" data-tabs-content="tabs">
        <div class="tabs-panel is-active" id="by-name">
                <table id="by-name-list">
                    <thead>
                        <tr>
                            <th>Name</th>
                            <th>Exc %</th>
                            <th>Exc</th>
                            <th>Inc %</th>
                            <th>Inc</th>
                            <th>Fold</th>
                            <th>First</th>
                            <th>Last</th>
                        </tr>
                    </thead>
                </table>
        </div>

        <div class="tabs-panel" id="callers">
                <table id="callersTree">
                    <thead>
                        <tr>
                            <th>Name</th>
                            <th>Exc %</th>
                            <th>Exc</th>
                            <th>Inc %</th>
                            <th>Inc</th>
                            <th>Fold</th>
                            <th>First</th>
                            <th>Last</th>
                        </tr>
                    </thead>
                    <tbody></tbody>
                </table>
        </div>
    </div>



    <!-- Do NOT Delete
      This allows for script tags and requires('') to work both in the browser and i Electron -->
    <script>if (typeof module === 'object') {window.module = module; module = undefined;}</script>


    <!-- Let's get some jQuery going here. -->
    <script src="../static/foundation-6.2.3-custom/js/vendor/jquery.js"></script>
    <script src="../libraries/jquery.treetable/jquery.treetable.js"></script>

    <script src="../js/stackDelegate.js"></script>

    
    <script>
        $(document).ready(function () {
            // Get tree ready
            var indenterTemplate = "<span class=\"indenter\"><a href=\"#\">&nbsp;</a></span>";

            // Initialize by-name-list and possibly set some properties
            $("#by-name-list").treetable();
            updateTreeTableHtml("#by-name-list", null, stackDelegate.summaryStackData);

            // Initialize callersTree and possibly set some properties
            $("#callersTree").treetable({
                expandable: true,
                indenterTemplate: indenterTemplate,
                onNodeExpand: function () {
                    var node = this;
                    // TODO: Place repeat children protection here (if node has a children present attribute)
                    callersTreeNodeExpanded(node);
                }
            });

            // TODO: Initialize other tree tables here
        });


        /*_____________________________________*/
        /*_______ Tab Updater Functions _______*/
        /*_____________________________________*/
        function updateTreeTableHtml(treeTableId, parentNode, stackData, forceParentNodeId = "") {
            // Iterate through each row
            var rowsToAppend = "";
            for (var i = 0; i < stackData.length; ++i) {
                var parentId = forceParentNodeId != "" ? forceParentNodeId : stackData[i].parentContextId;

                rowsToAppend = rowsToAppend + "<tr data-tt-id=\"" + stackData[i].contextId
                                            + "\" data-tt-parent-id=\"" + parentId
                                            + "\" data-tt-branch=\"" + stackData[i].hasChildren
                                            + "\" direct-children-loaded=\"false\">";

                rowsToAppend = rowsToAppend + "<td class=\"name-col\">" + stackData[i].name + "</td>\
                                    <td>" + stackData[i].exclusiveMetricPercent + "</td>\
                                    <td>" + stackData[i].exclusiveMetric + "</td>\
                                    <td>" + stackData[i].inclusiveMetricPercent + "</td>\
                                    <td>" + stackData[i].inclusiveMetric + "</td>\
                                    <td>" + stackData[i].exclusiveFoldedCount + "</td>\
                                    <td>" + stackData[i].firstTimeRelativeMSec + "</td>\
                                    <td>" + stackData[i].lastTimeRelativeMSec + "</td>\
                                    </tr>";
            }

            $(treeTableId).treetable("loadBranch", parentNode, rowsToAppend);  // treetable treats a null node parameter as meaning root
        }

        
        /*_____________________________________*/
        /*__________ Event Listeners __________*/
        /*_____________________________________*/

        /* by-name-list click event */
        $(document).on("dblclick", "#by-name-list tbody tr td:first-child", function (row) {
            //var focusNode = row.currentTarget.innerText.trim();  // Get the name of the clicked node
            var clickedNodeId = row.currentTarget.parentElement.getAttribute("data-tt-id");
            stackDelegate.focusNode = $("#by-name-list").treetable("node", clickedNodeId);
            $('#tabs').foundation('selectTab', $("#callers"));  // Switch to Callers tab

            getAndDisplayData();
        });

        function getAndDisplayData() {
            if (stackDelegate.focusNode !== undefined && stackDelegate.focusNode != null) {
                stackDelegate.getCallersData(stackDelegate.focusNode.id, "", function (callersStackData, status) {
                    $("#callersTree tbody").empty();  // TODO: Maybe unload branch, instead

                    var focusNodeHtml = "<tr data-tt-id=\"" + "callersTree_" + stackDelegate.focusNode.id
                                        + "\" data-tt-branch=\"true\" direct-children-loaded=\"true\">\
                                        " + stackDelegate.focusNode.row[0].innerHTML + "\
                                        " + "</tr>";

                    // Need to add stackDelegate.focusNode as parent node for this tree table
                    $("#callersTree").treetable("loadBranch", null, focusNodeHtml);
                    var parentNode = $("#callersTree").treetable("node", "callersTree_" + stackDelegate.focusNode.id);

                    // Place data in Callers tab
                    updateTreeTableHtml("#callersTree", parentNode, callersStackData, forceParentNodeId=parentNode.id);
                });

                // TODO: Add other tab update calls here
            }
        }

        /* callersTree node expand event */
        function callersTreeNodeExpanded(node) {
            if (node.row[0].getAttribute("direct-children-loaded") == "true") { return; }

            // Split the name from the path
            var nameAndPath = node.id.split("/");
            var name = nameAndPath[0];

            // Get the path, if there is one
            var path = "";
            // Check if there is actually a path component
            if (nameAndPath.length > 1) {
                // There is, so let's reconstruct it
                for (var i = 1; i < nameAndPath.length - 1; ++i) {
                    path += nameAndPath[i] + "/";
                }
                path += nameAndPath[nameAndPath.length - 1];
            }

            if (name !== undefined) {
                stackDelegate.getCallersData(name, path, function (callersStackData, status) {
                    if (status == "success") {
                        node.row[0].setAttribute("direct-children-loaded", "true");

                        // Place data under clicked node
                        updateTreeTableHtml("#callersTree", node, callersStackData);
                    }
                });
            }
        }

        $(".filter").keypress(function (e) {
            // If the user pressed enter in a filter textfield
            if (e.which == 13) {
                // TODO: Assign filter box values to respective keys in stackDelegate.filters dictionary
                stackDelegate.filters = $("#filtersForm").serialize();

                // Get updated summary stack data again and update By Name tab
                stackDelegate.getSummaryData(function (summaryStackData) {
                    $("#by-name-list tbody").empty();
                    updateTreeTableHtml("#by-name-list", null, stackDelegate.summaryStackData);
                    stackDelegate.focusNode = $("#by-name-list").treetable("node", stackDelegate.focusNode.id);
                });

                getAndDisplayData();
            }
        });
    </script>


    <script src="../static/foundation-6.2.3-custom/js/vendor/what-input.js"></script>
    <script src="../static/foundation-6.2.3-custom/js/vendor/foundation.js"></script>
    <script>
        $(document).foundation();
    </script>


    <!-- Do NOT Delete
      This allows for script tags and require statements to work both in the browser and in Electron -->
    <script>if (window.module) module = window.module;</script>



</body>
</html>