<!DOCTYPE html>
<html>
<head>
    <meta charset="utf-8" />
    <title>Stack Viewer</title>
    <link rel="stylesheet" href="../static/foundation-6.2.3-custom/css/foundation.css">
    <link rel="stylesheet" href="../static/foundation-6.2.3-custom/css/app.css">
    <link href="../libraries/jquery.treetable/css/jquery.treetable.css" rel="stylesheet" type="text/css" />
    <link href="../static/stackviewer.css" rel="stylesheet" type="text/css" />
</head>
<body>

    <ul class="tabs" data-tabs id="tabs">
        <li class="tabs-title is-active"><a href="#by-name" aria-selected="true">By Name</a></li>
        <li class="tabs-title"><a href="#caller-callee">Caller-Callee</a></li>
        <li class="tabs-title"><a href="#call-tree">CallTree</a></li>
        <li class="tabs-title"><a href="#callers">Callers</a></li>
        <li class="tabs-title"><a href="#callees">Callees</a></li>
        <li class="tabs-title"><a href="#notes">Notes</a></li>
    </ul>

    <div class="tabs-content" data-tabs-content="tabs">
        <div class="tabs-panel is-active" id="by-name">
                <table id="by-name-list">
                    <thead>
                        <tr>
                            <th>Name</th>
                            <th>Exc %</th>
                            <th>Exc</th>
                            <th>Inc %</th>
                            <th>Inc</th>
                            <th>Fold</th>
                            <th>First</th>
                            <th>Last</th>
                        </tr>
                    </thead>
                </table>
        </div>

        <div class="tabs-panel" id="callers">
                <table id="callersTree">
                    <thead>
                        <tr>
                            <th>Name</th>
                            <th>Exc %</th>
                            <th>Exc</th>
                            <th>Inc %</th>
                            <th>Inc</th>
                            <th>Fold</th>
                            <th>First</th>
                            <th>Last</th>
                        </tr>
                    </thead>
                </table>
        </div>
    </div>



    <!-- Do NOT Delete
      This allows for script tags and requires('') to work both in the browser and i Electron -->
    <script>if (typeof module === 'object') {window.module = module; module = undefined;}</script>


    <!-- Let's get some jQuery going here. -->
    <script src="../static/foundation-6.2.3-custom/js/vendor/jquery.js"></script>
    <script src="../libraries/jquery.treetable/jquery.treetable.js"></script>

    <script src="../js/stackDelegate.js"></script>

    
    <script>
        $(document).ready(function () {
            // Get tree ready
            var indenterTemplate = "<span class=\"indenter\"><a href=\"#\">&nbsp;</a></span>";

            // Initialize by-name-list with said properties
            $("#by-name-list").treetable({
                expandable: true,
                indenterTemplate: indenterTemplate,
                onNodeExpand: function () {
                    var node = this;

                    console.log(node);
                }
            });

            // Initialize callersTree with said properties
            $("#callersTree").treetable({
                expandable: true,
                indenterTemplate: indenterTemplate,
                onNodeExpand: function () {
                    var node = this;

                    callersTreeNodeExpanded(node);
                }
            });

            updateTreeTable("#by-name-list", null, stackDelegate.summaryStackData);
        });


        /*_____________________________________*/
        /*_______ Tab Updater Functions _______*/
        /*_____________________________________*/
        function updateTreeTable(treeTableId, parentNode, stackData) {
            console.log(parentNode);

            var rowsToAppend = "";

            // Iterate through each row
            for (var i = 0; i < stackData.length; ++i) {
                var name = stackData[i].name;
                var exclusiveMetricPercent = stackData[i].exclusiveMetricPercent;
                var exclusiveMetric = stackData[i].exclusiveMetric;
                var inclusiveMetricPercent = stackData[i].inclusiveMetricPercent;
                var inclusiveMetric = stackData[i].inclusiveMetric;
                var exclusiveFoldedCount = stackData[i].exclusiveFoldedCount;
                var firstTimeRelativeMSec = stackData[i].firstTimeRelativeMSec;
                var lastTimeRelativeMSec = stackData[i].lastTimeRelativeMSec;
                var parentContextId = stackData[i].parentContextId;
                var contextId = stackData[i].contextId;
                var hasChildren = stackData[i].hasChildren;

                // TODO: Wrap this up in a function or something nicer
                if (parentNode != null && parentNode != undefined) {
                    var childNodeAlreadyPresent = false;
                    for (var j = 0; j < parentNode.children.length; ++j) {
                        if (parentNode.children[j].id == contextId) { childNodeAlreadyPresent = true; }
                    }
                    if (childNodeAlreadyPresent) { continue; }
                }

                rowsToAppend = rowsToAppend + "<tr data-tt-id=\"" + contextId + "\" data-tt-parent-id=\"" + parentContextId + "\" data-tt-branch=\"" + hasChildren + "\">";

                rowsToAppend = rowsToAppend + "<td>" + name + "</td>\
                                    <td>" + exclusiveMetricPercent + "</td>\
                                    <td>" + exclusiveMetric + "</td>\
                                    <td>" + inclusiveMetricPercent + "</td>\
                                    <td>" + inclusiveMetric + "</td>\
                                    <td>" + exclusiveFoldedCount + "</td>\
                                    <td>" + firstTimeRelativeMSec + "</td>\
                                    <td>" + lastTimeRelativeMSec + "</td>\
                                    </tr>";
            }

            $(treeTableId).treetable("loadBranch", parentNode, rowsToAppend);  // treetable treats a null node parameter as meaning root
        }

        
        /*_____________________________________*/
        /*__________ Event Listeners __________*/
        /*_____________________________________*/

        // by-name-list click event
        $(document).on("dblclick", "#by-name-list tbody tr", function (row) {
            var name = row.currentTarget.children[0].innerText.trim();  // Get the name of the clicked node

            if (name !== undefined) {
                stackDelegate.getCallerTree(name, "", function (callersStackData) {
                    // Switch to Callers tab
                    $('#tabs').foundation('selectTab', $("#callers"));

                    // Place data in Callers tab
                    updateTreeTable("#callersTree", null, callersStackData);
                });
            }
        });

        // callersTree node expand event
        //$(document).on("dblclick", "#callersTree tbody tr", function (row) {
        function callersTreeNodeExpanded(node) {
            // Get the nodeId (contains the name and path) of the row the user just clicked on

            // Split the name from the path
            var nameAndPath = node.id.split("/");
            var name = nameAndPath[0];

            // Get the path, if there is one
            var path = "";
            // Check if there is actually a path component
            if (nameAndPath.length > 1) {
                // There is, so let's reconstruct it
                for (var i = 1; i < nameAndPath.length - 1; ++i) {
                    path += nameAndPath[i] + "/";
                }
                path += nameAndPath[nameAndPath.length - 1];
            }

            if (name !== undefined) {
                stackDelegate.getCallerTree(name, path, function (callersStackData) {
                    // Place data under clicked node
                    updateTreeTable("#callersTree", node, callersStackData);
                });
            }
        }
        //});
    </script>


    <script src="../static/foundation-6.2.3-custom/js/vendor/what-input.js"></script>
    <script src="../static/foundation-6.2.3-custom/js/vendor/foundation.js"></script>
    <script>
        $(document).foundation();
    </script>


    <!-- Do NOT Delete
      This allows for script tags and require statements to work both in the browser and in Electron -->
    <script>if (window.module) module = window.module;</script>



</body>
</html>