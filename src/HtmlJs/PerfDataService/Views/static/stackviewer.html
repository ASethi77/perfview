<!DOCTYPE html>
<html>
<head>
    <meta charset="utf-8" />
    <title>Stack Viewer</title>
    <link rel="stylesheet" href="../static/foundation-6.2.3-custom/css/foundation.css">
    <link rel="stylesheet" href="../static/foundation-6.2.3-custom/css/app.css">
    <link href="../libraries/jquery.treetable/css/jquery.treetable.css" rel="stylesheet" type="text/css" />
    <link href="../static/stackviewer.css" rel="stylesheet" type="text/css" />
</head>
<body>
    <div class="nav"></div>

    <form id="filtersForm">
        Start:<input class="filter" name="start" list="start-filter-list" type="text">
        <datalist id="start-filter-list"></datalist>

        End:<input class="filter" name="end" list="end-filter-list" type="text">
        <datalist id="end-filter-list"></datalist>

        GroupPats:<input class="filter" name="grouppats" list="grouppats-filter-list" type="text">
        <datalist id="grouppats-filter-list"></datalist>

        Fold%:<input class="filter" name="foldpct" list="foldpercent-filter-list" type="text" value="1">
        <datalist id="foldpercent-filter-list"></datalist>

        FoldPats:<input class="filter" name="foldpats" list="foldpats-filter-list" type="text">
        <datalist id="foldpats-filter-list"></datalist>

        IncPats:<input class="filter" name="incpats" list="incpats-filter-list" type="text">
        <datalist id="incpats-filter-list"></datalist>

        ExcPats:<input class="filter" name="excpats" list="excpats-filter-list" type="text">
        <datalist id="excpats-filter-list"></datalist>
    </form>

    <ul class="tabs" data-tabs id="tabs">
        <li class="tabs-title is-active"><a href="#by-name" aria-selected="true">By Name</a></li>
        <li class="tabs-title"><a href="#call-tree">CallTree</a></li>
        <li class="tabs-title"><a href="#callers">Callers</a></li>
        <li class="tabs-title"><a href="#callees">Callees</a></li>
    </ul>

    <div class="tabs-content" data-tabs-content="tabs">
        <div class="tabs-panel is-active" id="by-name">
            Find:<input class="filter find" name="find" type="text">
            <table id="by-name-list">
                <thead>
                    <tr>
                        <th>Name</th>
                        <th>Exc %</th>
                        <th>Exc</th>
                        <th>Inc %</th>
                        <th>Inc</th>
                        <th>Fold</th>
                        <th>First</th>
                        <th>Last</th>
                    </tr>
                </thead>
            </table>
        </div>

        <div class="tabs-panel" id="call-tree">
            Find:<input class="filter find" name="find" type="text">
            <table id="call-treeTree">
                <thead>
                    <tr>
                        <th>Name</th>
                        <th>Exc %</th>
                        <th>Exc</th>
                        <th>Inc %</th>
                        <th>Inc</th>
                        <th>Fold</th>
                        <th>First</th>
                        <th>Last</th>
                    </tr>
                </thead>
                <tbody></tbody>
            </table>
        </div>

        <div class="tabs-panel" id="callers">
            Find:<input class="filter find" name="find" type="text">
                <table id="callersTree">
                    <thead>
                        <tr>
                            <th>Name</th>
                            <th>Exc %</th>
                            <th>Exc</th>
                            <th>Inc %</th>
                            <th>Inc</th>
                            <th>Fold</th>
                            <th>First</th>
                            <th>Last</th>
                        </tr>
                    </thead>
                    <tbody></tbody>
                </table>
        </div>

        <div class="tabs-panel" id="callees">
            Find:<input class="filter find" name="find" type="text">
            <table id="calleesTree">
                <thead>
                    <tr>
                        <th>Name</th>
                        <th>Exc %</th>
                        <th>Exc</th>
                        <th>Inc %</th>
                        <th>Inc</th>
                        <th>Fold</th>
                        <th>First</th>
                        <th>Last</th>
                    </tr>
                </thead>
                <tbody></tbody>
            </table>
        </div>
    </div>


    <footer id="footer"></footer>



    <!-- Do NOT Delete
      This allows for script tags and requires('') to work both in the browser and i Electron -->
    <script>if (typeof module === 'object') {window.module = module; module = undefined;}</script>


    <!-- Let's get some jQuery going here. -->
    <script src="../static/foundation-6.2.3-custom/js/vendor/jquery.js"></script>
    <script src="../libraries/jquery.treetable/jquery.treetable.js"></script>

    <script src="../js/stackDelegate.js"></script>


    <!-- Template Including -->
    <script>
        $.get('templates/navbar.html', function(data) {
          var template = $(data).children();
          $('.nav').append(template);
        });

        $.get('templates/footer.html', function(data) {
          var template = $(data).children();
          $('#footer').append(template);
        })
    </script>

    
    <script>
        $(document).ready(function () {
            // Get tree ready
            var indenterTemplate = "<span class=\"indenter\"><a href=\"#\">&nbsp;</a></span>";

            // Initialize by-name-list and possibly set some properties
            $("#by-name-list").treetable({
                indenterTemplate: "<span></span>"
            });

            // Initialize call-treeTree and possibly set some properties
            $("#call-treeTree").treetable({
                expandable: true,
                indenterTemplate: indenterTemplate,
                onNodeExpand: function () {
                    var node = this;
                    onTreeNodeExpand(node, "#call-treeTree");
                }
            });
            
            // Load data into by-name-list and call-treeTree
            stackDelegate.filters = $("#filtersForm").serialize();  // In case there are any default filter values set
            loadAndDisplayData(["by-name-list", "call-treeTree"], false);

            // Initialize callersTree and possibly set some properties
            $("#callersTree").treetable({
                expandable: true,
                indenterTemplate: indenterTemplate,
                onNodeExpand: function () {
                    var node = this;
                    onTreeNodeExpand(node, "#callersTree");
                }
            });

            // Initialize calleesTree and possibly set some properties
            $("#calleesTree").treetable({
                expandable: true,
                indenterTemplate: indenterTemplate,
                onNodeExpand: function () {
                    var node = this;
                    onTreeNodeExpand(node, "#calleesTree");
                }
            });
        });


        /*_____________________________________*/
        /*_______ Tab Updater Function ________*/
        /*_____________________________________*/
        /* OPTIONS:
        "forceParentNodeId" : "id"
        */
        function updateTreeTableHtml(treeTableId, parentNode, stackData, options={}) {
            // Iterate through each row
            var rowsToAppend = "";
            var dataIncludesSearchResults = false;

            for (var i = 0; i < stackData.length; ++i) {
                var findFlag = (stackData[i].findFlag != "" && treeTableId == "#" + $(".tabs-panel.is-active table").attr("id") ? "\" data-find-flag=\"" + stackData[i].findFlag : "");
                dataIncludesSearchResults = dataIncludesSearchResults || findFlag.length;

                rowsToAppend = rowsToAppend + "<tr data-tt-id=\"" + stackData[i].contextId
                                            + "\" data-tt-parent-id=\"" + stackData[i].parentContextId
                                            + "\" data-tt-branch=\"" + stackData[i].hasChildren
                                            + findFlag
                                            + "\">";

                rowsToAppend = rowsToAppend + "<td class=\"name-col\">" + stackData[i].name + "</td>\
                                    <td>" + stackData[i].exclusiveMetricPercent + "</td>\
                                    <td>" + stackData[i].exclusiveMetric + "</td>\
                                    <td>" + stackData[i].inclusiveMetricPercent + "</td>\
                                    <td>" + stackData[i].inclusiveMetric + "</td>\
                                    <td>" + stackData[i].exclusiveFoldedCount + "</td>\
                                    <td>" + stackData[i].firstTimeRelativeMSec + "</td>\
                                    <td>" + stackData[i].lastTimeRelativeMSec + "</td>\
                                    </tr>";
            }

            $(treeTableId).treetable("loadBranch", parentNode, rowsToAppend);  // treetable treats a null node parameter as meaning root
                
            if (dataIncludesSearchResults) {
                $(treeTableId + " tbody tr").each(function(index) {
                    var hasChildren = $(treeTableId).treetable("node", $(this).attr("data-tt-id")).children.length > 0;
                    if (hasChildren) { $(treeTableId).treetable("expandNode", $(this).attr("data-tt-id")) };
                }); 
            }
        }

        
        /*_____________________________________*/
        /*__________ Event Listeners __________*/
        /*_____________________________________*/

        /* by-name-list click event */
        $(document).on("dblclick", "#by-name-list tbody tr td:first-child", function (row) {
            //var focusNode = row.currentTarget.innerText.trim();  // Get the name of the clicked node
            var clickedNodeId = row.currentTarget.parentElement.getAttribute("data-tt-id");
            var newFocusNode = $("#by-name-list").treetable("node", clickedNodeId);
            stackDelegate.setFocusNode(newFocusNode);
            $('#tabs').foundation('selectTab', $("#callers"));  // Switch to Callers tab

            loadAndDisplayData(["callersTree", "calleesTree"], false);
        });

        /* callersTree click event */
        $(document).on("dblclick", "#callersTree tbody tr td:first-child", function (row) {
            //var focusNode = row.currentTarget.innerText.trim();  // Get the name of the clicked node
            var clickedNodeId = row.currentTarget.parentElement.getAttribute("data-tt-id");
            //var clickedNodeId = row.currentTarget.innerText.trim();
            
            var newFocusNode = $("#callersTree").treetable("node", clickedNodeId);
            stackDelegate.setFocusNode(newFocusNode);

            loadAndDisplayData(["callersTree", "calleesTree"], false);
        });


        /* calleesTree click event */
        $(document).on("dblclick", "#calleesTree tbody tr td:first-child", function (row) {
            //var focusNode = row.currentTarget.innerText.trim();  // Get the name of the clicked node
            var clickedNodeId = row.currentTarget.parentElement.getAttribute("data-tt-id");
            //var clickedNodeId = row.currentTarget.innerText.trim();
            
            var newFocusNode = $("#calleesTree").treetable("node", clickedNodeId);
            stackDelegate.setFocusNode(newFocusNode);

            loadAndDisplayData(["calleesTree", "callersTree"], false);
        });


        function loadAndDisplayData(treesToUpdate, includeSearch=true) {
            // DISPLAY BY-NAME DATA
            if (treesToUpdate == null || treesToUpdate.includes("by-name-list")) {
                stackDelegate.getSummaryData(function (summaryStackData) {
                    $("#by-name-list tbody").empty();  // TODO: Maybe unload branch, instead
                    updateTreeTableHtml("#by-name-list", null, stackDelegate.summaryStackData);
                    if (stackDelegate.focusNode != null) {
                        var newFocusNode = $("#by-name-list").treetable("node", stackDelegate.focusNode.id);
                        stackDelegate.setFocusNode(newFocusNode);
                    }
                });
            }

            // LOAD AND DISPLAY CALLTREE DATA
            if (treesToUpdate == null || treesToUpdate.includes("call-treeTree")) {
                stackDelegate.getNode("ROOT", function(nodeData){
                    $("#call-treeTree tbody").empty();

                    // Place root node in tree
                    updateTreeTableHtml("#call-treeTree", null, [nodeData]);

                    var options = {"overrideFocusNode" : "ROOT"};
                    stackDelegate.getCalleesData(function (callTreeStackData, status) {
                        // Place data in CallTree tab
                        var parentNode = $("#call-treeTree").treetable("node", "ROOT");
                        updateTreeTableHtml("#call-treeTree", parentNode, callTreeStackData);
                    }, options);
                });
            }

            // LOAD AND DISPLAY CALLERS DATA
            if ((treesToUpdate == null || treesToUpdate.includes("callersTree")) && stackDelegate.focusNode != null) {
                var options = {"includeSearch" : true};
                stackDelegate.getCallersData(function (callersStackData, status) {
                    $("#callersTree tbody").empty();

                    var focusNodeHtml = "<tr data-tt-id=\"" + stackDelegate.focusNode.id
                                        + "\" data-tt-branch=\"true\" direct-children-loaded=\"true\">\
                                        " + stackDelegate.focusNode.row[0].innerHTML + "\
                                        " + "</tr>";

                    // Need to add stackDelegate.focusNode as parent node for this tree table
                    $("#callersTree").treetable("loadBranch", null, focusNodeHtml);
                    var parentNode = $("#callersTree").treetable("node", stackDelegate.focusNode.id);

                    // Place data in Callers tab
                    updateTreeTableHtml("#callersTree", parentNode, callersStackData);
                }, options);
            }
            
            // LOAD AND DISPLAY CALLEES DATA
            if ((treesToUpdate == null || treesToUpdate.includes("calleesTree")) && stackDelegate.focusNode != null) {
                stackDelegate.getCalleesData(function (calleesStackData, status) {
                    $("#calleesTree tbody").empty();

                    var focusNodeHtml = "<tr data-tt-id=\"" + stackDelegate.focusNode.id
                                        + "\" data-tt-branch=\"true\" direct-children-loaded=\"true\">\
                                        " + stackDelegate.focusNode.row[0].innerHTML + "\
                                        " + "</tr>";

                    // Need to add stackDelegate.focusNode as parent node for this tree table
                    $("#calleesTree").treetable("loadBranch", null, focusNodeHtml);
                    var parentNode = $("#calleesTree").treetable("node", stackDelegate.focusNode.id);

                    // Place data in Callees tab
                    updateTreeTableHtml("#calleesTree", parentNode, calleesStackData);
                });
            }
        }


        /* Tree node expand event */
        function onTreeNodeExpand(node, treeName) {
            if (node.children.length > 0) { return; }

            var options = {"overrideFocusNode" : node.id };

            if (treeName == "#callersTree") {
                // TODO: Fix so that find is not included in this
                stackDelegate.getCallersData(function (callersStackData, status) {
                    if (status == "success") {
                        node.row[0].setAttribute("direct-children-loaded", "true");

                        // Place data under clicked node
                        updateTreeTableHtml(treeName, node, callersStackData);
                    }
                }, options);
            } else if (treeName == "#calleesTree") {
                stackDelegate.getCalleesData(function (calleesStackData, status) {
                    if (status == "success") {
                        node.row[0].setAttribute("direct-children-loaded", "true");

                        // Place data under clicked node
                        updateTreeTableHtml(treeName, node, calleesStackData);
                    }
                }, options);
            } else if (treeName == "#call-treeTree") {
                stackDelegate.getCalleesData(function (calleesStackData, status) {
                    if (status == "success") {
                        node.row[0].setAttribute("direct-children-loaded", "true");

                        // Place data under clicked node
                        updateTreeTableHtml(treeName, node, calleesStackData);
                    }
                }, options);
            }
        }


        $(".filter").keypress(function (e) {
            // If the user pressed enter in a filter textfield
            if (e.which == 13) {
                stackDelegate.filters = $("#filtersForm").serialize();

                // If find was used, only update the current tab
                if (e.target.name == "find") {
                    var activeTreeName = $(".tabs-panel.is-active table").attr("id");
                    loadAndDisplayData([activeTreeName]);
                } else {
                    // Get updated summary stack data again and update By Name tab
                    loadAndDisplayData();
                }
            }
        });
    </script>


    <script src="../static/foundation-6.2.3-custom/js/vendor/what-input.js"></script>
    <script src="../static/foundation-6.2.3-custom/js/vendor/foundation.js"></script>
    <script>
        $(document).foundation();
    </script>


    <!-- Do NOT Delete
      This allows for script tags and require statements to work both in the browser and in Electron -->
    <script>if (window.module) module = window.module;</script>



</body>
</html>